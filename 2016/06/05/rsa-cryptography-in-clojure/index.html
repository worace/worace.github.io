<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="last-modified" content="2021-04-14T18:07:56-07:00" />

  <title>
    
      RSA Cryptography In Clojure
    
  </title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300;400&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet"> 

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/TroutIcon48x48.png">
  <link rel="alternate" type="application/atom+xml" title="Horace Williams" href="/atom.xml">

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117025935-1"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-117025935-1');
  </script>
  
</head>


  <body>

    <div class="container content">
      
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Horace Williams</a>
        </h3>
        <ul class="nav-links">
          <li><a href="/about">about</a></li>
          <li><a target="_blank" class="nav-twitter" href="https://twitter.com/worace"><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48"><path d="M 32 6 C 26.568583 6 22.160643 10.388731 22.042969 15.792969 C 17.240727 15.216998 14.113589 13.421507 12.195312 11.652344 C 10.067982 9.6903754 9.3945312 7.9472656 9.3945312 7.9472656 A 1.50015 1.50015 0 0 0 6.8007812 7.5996094 C 6.8007812 7.5996094 5 10 5 13.5 C 5 15.500985 5.6317952 16.981554 6.3847656 18.236328 C 6.3570276 18.223338 6.1699219 18.158203 6.1699219 18.158203 A 1.50015 1.50015 0 0 0 4.0058594 19.636719 C 4.0058594 19.636719 4.5832039 23.856843 8.5507812 26.941406 L 8.1367188 27.044922 A 1.50015 1.50015 0 0 0 7.1972656 29.244141 C 7.1972656 29.244141 7.8700527 30.382221 9.2792969 31.580078 C 10.11485 32.290298 11.34227 33.023169 12.789062 33.701172 C 11.012271 34.35044 8.362818 35 4.5 35 A 1.50015 1.50015 0 0 0 3.3710938 37.488281 C 3.3710938 37.488281 4.5173251 38.751002 6.7832031 39.849609 C 9.0490812 40.948217 12.539474 42 17.5 42 C 26.219697 42 32.484656 37.817151 36.394531 32.515625 C 40.304407 27.214099 42 20.861111 42 16 C 42 15.691547 41.980739 15.387437 41.953125 15.085938 C 44.064371 13.051602 44.856626 11.522235 44.894531 11.447266 C 45.084531 11.066266 45.01375 10.608688 44.71875 10.304688 C 44.42475 9.9996875 43.969031 9.9137969 43.582031 10.091797 L 43.419922 10.166016 C 43.280922 10.230016 43.141953 10.294422 43.001953 10.357422 C 43.408953 9.7084219 43.730125 9.014875 43.953125 8.296875 C 44.077125 7.900875 43.943234 7.4669375 43.615234 7.2109375 C 43.287234 6.9549375 42.835469 6.9275312 42.480469 7.1445312 C 41.258221 7.8873594 40.086652 8.40739 38.867188 8.7558594 C 37.072578 7.0534724 34.656873 6 32 6 z M 32 9 C 35.883178 9 39 12.116822 39 16 C 39 20.138889 37.445593 26.035901 33.980469 30.734375 C 30.515344 35.432849 25.280303 39 17.5 39 C 13.7348 39 11.230189 38.318942 9.3535156 37.582031 C 11.319341 37.276755 13.011947 36.869367 14.228516 36.398438 C 16.338182 35.581792 17.476563 34.638672 17.476562 34.638672 A 1.50015 1.50015 0 0 0 16.863281 32.044922 C 14.140556 31.364241 12.394328 30.263307 11.298828 29.345703 L 12.863281 28.955078 A 1.50015 1.50015 0 0 0 13.039062 26.099609 C 9.7939415 24.851486 8.4312292 23.086373 7.734375 21.607422 C 8.5823538 21.782967 9.3718961 22 10.5 22 A 1.50015 1.50015 0 0 0 11.169922 19.158203 C 11.169922 19.158203 8 17.7 8 13.5 C 8 12.745947 8.2088435 12.268355 8.3613281 11.697266 C 8.884507 12.400354 9.3156815 13.07859 10.160156 13.857422 C 12.734824 16.231954 16.990366 18.653154 23.419922 18.998047 A 1.50015 1.50015 0 0 0 25 17.5 L 25 16 C 25 12.116822 28.116822 9 32 9 z"/></svg>
</a></li>
        </ul>
      </header>
      

      <main>
        <article class="post">
  <h1 class="post-title">RSA Cryptography In Clojure</h1>
  <h2 class="post-subtitle"><em></em></h2>
  <time datetime="2016-06-05T00:00:00-07:00" class="post-date">05 Jun 2016</time>
  <p>I recently found myself needing to do some public/private key cryptography using RSA in Clojure. Fortunately there is pretty good library support for doing this kind of thing in Java, but it still took me a while to get all of the interop working. Additionally, I needed to be able to serialize and de-serialize keys in a couple of formats (.pem and .der, specifically), so we&#8217;ll look at setting this up as well.</p>
<h2>Generating a Keypair</h2>
<p>Keys are generated based on the desired length and algorithm. To generate a key we have to do a little bit of Java ceremony around requesting a <code>KeyPairGenerator</code>.</p>
<p>We can use this to generate a Private Key, and from that Private Key retrieve the Public Key if needed.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">kp-generator</span> <span class="p">[</span><span class="nv">length</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">java.security.KeyPairGenerator/getInstance</span> <span class="s">&quot;RSA&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">.initialize</span> <span class="nv">length</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">generate-keypair</span> <span class="p">[</span><span class="nv">length</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">assert </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">length</span> <span class="mi">512</span><span class="p">)</span> <span class="s">&quot;RSA Key must be at least 512 bits long.&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">.generateKeyPair</span> <span class="p">(</span><span class="nf">kp-generator</span> <span class="nv">length</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">keypair</span> <span class="p">(</span><span class="nf">generate-keypair</span> <span class="mi">512</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">public-key</span> <span class="p">(</span><span class="nf">.getPublic</span> <span class="nv">keypair</span><span class="p">))</span>
</pre></div>
<h2>Encrypting, Decrypting, and Encoding Messages</h2>
<p>The Java crypto methods we&#8217;re using generally return a Byte Array of their encrypted data. For my use-case I wanted to encode these in Base64, which is easy in Java 8 thanks to the built-in Base64 module (For earlier versions, check out <a href="https://docs.oracle.com/javase/7/docs/api/javax/xml/bind/DatatypeConverter.html">javax.xml.bind.DatatypeConverter</a>).</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">decode64</span> <span class="p">[</span><span class="nv">str</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">.decode</span> <span class="p">(</span><span class="nf">java.util.Base64/getDecoder</span><span class="p">)</span> <span class="nv">str</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">encode64</span> <span class="p">[</span><span class="nv">bytes</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">.encodeToString</span> <span class="p">(</span><span class="nf">java.util.Base64/getEncoder</span><span class="p">)</span> <span class="nv">bytes</span><span class="p">))</span>
</pre></div>
<p>Now we can use the keys we generated to encrypt and decrypt a message. This being public/private key crypto, remember of course that encryption is done using the public key and decryption using the private.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">encrypt</span> <span class="p">[</span><span class="nv">message</span> <span class="nv">public-key</span><span class="p">]</span>
  <span class="s">&quot;Perform RSA public key encryption of the given message string.</span>
<span class="s">   Returns a Base64-encoded string of the encrypted data.&quot;</span>
  <span class="p">(</span><span class="nf">encode64</span>
   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cipher</span> <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">javax.crypto.Cipher/getInstance</span> <span class="s">&quot;RSA/ECB/PKCS1Padding&quot;</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">.init</span> <span class="nv">javax.crypto.Cipher/ENCRYPT_MODE</span> <span class="nv">public-key</span><span class="p">))]</span>
     <span class="p">(</span><span class="nf">.doFinal</span> <span class="nv">cipher</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">message</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">decrypt</span> <span class="p">[</span><span class="nv">message</span> <span class="nv">private-key</span><span class="p">]</span>
  <span class="s">&quot;Use an RSA private key to decrypt a Base64-encoded string</span>
<span class="s">   of ciphertext.&quot;</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cipher</span> <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">javax.crypto.Cipher/getInstance</span> <span class="s">&quot;RSA/ECB/PKCS1Padding&quot;</span><span class="p">)</span>
                 <span class="p">(</span><span class="nf">.init</span> <span class="nv">javax.crypto.Cipher/DECRYPT_MODE</span> <span class="nv">private-key</span><span class="p">))]</span>
    <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">message</span>
         <span class="nv">decode64</span>
         <span class="p">(</span><span class="nf">.doFinal</span> <span class="nv">cipher</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">map </span><span class="nv">char</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">apply </span><span class="nv">str</span><span class="p">))))</span>
</pre></div>
<h2>Signing and Verifying</h2>
<p>The other big asymmetric crypto operation is to sign using a private key and verify using a public key. This is pretty easy with a bit of Java interop as well.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">sign</span>
  <span class="s">&quot;RSA private key signing of a message. Takes message as string&quot;</span>
  <span class="p">[</span><span class="nv">message</span> <span class="nv">private-key</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">encode64</span>
   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">msg-data</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">message</span><span class="p">)</span>
         <span class="nv">sig</span> <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">java.security.Signature/getInstance</span> <span class="s">&quot;SHA256withRSA&quot;</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">.initSign</span> <span class="nv">private-key</span> <span class="p">(</span><span class="nf">java.security.SecureRandom.</span><span class="p">))</span>
               <span class="p">(</span><span class="nf">.update</span> <span class="nv">msg-data</span><span class="p">))]</span>
     <span class="p">(</span><span class="nf">.sign</span> <span class="nv">sig</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">verify</span> <span class="p">[</span><span class="nv">encoded-sig</span> <span class="nv">message</span> <span class="nv">public-key</span><span class="p">]</span>
  <span class="s">&quot;RSA public key verification of a Base64-encoded signature and an</span>
<span class="s">   assumed source message. Returns true/false if signature is valid.&quot;</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">msg-data</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">message</span><span class="p">)</span>
        <span class="nv">signature</span> <span class="p">(</span><span class="nf">decode64</span> <span class="nv">encoded-sig</span><span class="p">)</span>
        <span class="nv">sig</span> <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">java.security.Signature/getInstance</span> <span class="s">&quot;SHA256withRSA&quot;</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">.initVerify</span> <span class="nv">public-key</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">.update</span> <span class="nv">msg-data</span><span class="p">))]</span>
    <span class="p">(</span><span class="nf">.verify</span> <span class="nv">sig</span> <span class="nv">signature</span><span class="p">)))</span>
</pre></div>
<h2>Serializing and Deserializing Keys</h2>
<p>Finally for my use-case it was important to be able to serialize and de-serialize keys in a format that would be readable by other systems. I found this part the trickiest to get working due to relatively sparse documentation and some confusion about the various formats and key serialization algorithms, but here it is.</p>
<h3>DER Encoding Public Keys</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">der-string-&gt;pub-key</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span>
  <span class="s">&quot;Generate an RSA public key from a DER-encoded Base64 string.</span>
<span class="s">   Some systems like to line-wrap these at 64 characters, so we</span>
<span class="s">   have to get rid of any newlines before decoding.&quot;</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">non-wrapped</span> <span class="p">(</span><span class="nf">clojure.string/replace</span> <span class="nv">string</span> <span class="o">#</span><span class="s">&quot;\n&quot;</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="nv">key-bytes</span> <span class="p">(</span><span class="nf">decode64</span> <span class="nv">non-wrapped</span><span class="p">)</span>
        <span class="nv">spec</span> <span class="p">(</span><span class="nf">java.security.spec.X509EncodedKeySpec.</span> <span class="nv">key-bytes</span><span class="p">)</span>
        <span class="nv">key-factory</span> <span class="p">(</span><span class="nf">java.security.KeyFactory/getInstance</span> <span class="s">&quot;RSA&quot;</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">.generatePublic</span> <span class="nv">key-factory</span> <span class="nv">spec</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">public-key-&gt;der-string</span> <span class="p">[</span><span class="nv">key</span><span class="p">]</span>
  <span class="s">&quot;Generate DER-formatted string for a public key.&quot;</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">key</span>
      <span class="nv">.getEncoded</span>
      <span class="nv">encode64</span>
      <span class="p">(</span><span class="nf">clojure.string/replace</span> <span class="o">#</span><span class="s">&quot;\n&quot;</span> <span class="s">&quot;&quot;</span><span class="p">)))</span>
</pre></div>
<h3>DER Encoding Private Keys</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">der-string-&gt;private-key</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">.generatePrivate</span> <span class="p">(</span><span class="nf">java.security.KeyFactory/getInstance</span> <span class="s">&quot;RSA&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="nf">java.security.spec.PKCS8EncodedKeySpec.</span>
                     <span class="p">(</span><span class="nf">decode64</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">string</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">private-key-&gt;der-string</span> <span class="p">[</span><span class="nv">pk</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">pk</span>
      <span class="nv">.getEncoded</span>
      <span class="nv">java.security.spec.PKCS8EncodedKeySpec.</span>
      <span class="nv">.getEncoded</span>
      <span class="nv">encode64</span><span class="p">))</span>
</pre></div>
<h2>PEM-Encoding</h2>
<p>PEM-encoding is another common format for serializing cryptographic keys. I was able to get everything so far working using just pieces from Java&#8217;s standard library, but after much experimentation could never get it to read PEM-encoded keys reliably. So I ended up reaching for <a href="https://www.bouncycastle.org/java.html">Bouncy Castle</a>, one of the go-to crypto Java crypto libraries.</p>
<p>BC supports a sizeable menu of different signing, hashing, and encryption algorithms. Fortunately for me reading and writing PEM keys was tucked in among them.</p>
<p>To pull in BouncyCastle I used this <code>project.clj</code> configuration for leiningen:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defproject </span><span class="nv">block-chain</span> <span class="s">&quot;0.2.0&quot;</span>
  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.8.0&quot;</span><span class="p">]</span>
                 <span class="p">[</span><span class="nv">org.bouncycastle/bcpkix-jdk15on</span> <span class="s">&quot;1.53&quot;</span><span class="p">]])</span>
</pre></div>
<p>Then used it to decode the keys.</p>
<div class="highlight"><pre><span></span><span class="c1">;; Have to do this bit of setup first so the keyparsers</span>
<span class="c1">;; can find BouncyCastle</span>
<span class="p">(</span><span class="nf">java.security.Security/addProvider</span> <span class="p">(</span><span class="nf">org.bouncycastle.jce.provider.BouncyCastleProvider.</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">keydata</span> <span class="p">[</span><span class="nv">reader</span><span class="p">]</span>
 <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">reader</span>
      <span class="p">(</span><span class="nf">org.bouncycastle.openssl.PEMParser.</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.readObject</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">pem-string-&gt;key-pair</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span>
  <span class="s">&quot;Convert a PEM-formatted private key string to a public/private keypair.</span>
<span class="s">   Returns java.security.KeyPair.&quot;</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">kd</span> <span class="p">(</span><span class="nf">keydata</span> <span class="p">(</span><span class="nf">io/reader</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">string</span><span class="p">)))]</span>
    <span class="p">(</span><span class="nf">.getKeyPair</span> <span class="p">(</span><span class="nf">org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter.</span><span class="p">)</span> <span class="nv">kd</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">pem-string-&gt;pub-key</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span>
  <span class="s">&quot;Convert a PEM-formatted public key string to an RSA public key.</span>
<span class="s">   Returns sun.security.rsa.RSAPublicKeyImpl&quot;</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">kd</span> <span class="p">(</span><span class="nf">keydata</span> <span class="p">(</span><span class="nf">io/reader</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="nv">string</span><span class="p">)))</span>
        <span class="nv">kf</span> <span class="p">(</span><span class="nf">java.security.KeyFactory/getInstance</span> <span class="s">&quot;RSA&quot;</span><span class="p">)</span>
        <span class="nv">spec</span> <span class="p">(</span><span class="nf">java.security.spec.X509EncodedKeySpec.</span> <span class="p">(</span><span class="nf">.getEncoded</span> <span class="nv">kd</span><span class="p">))]</span>
    <span class="p">(</span><span class="nf">.generatePublic</span> <span class="nv">kf</span> <span class="nv">spec</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">format-pem-string</span> <span class="p">[</span><span class="nv">encoded</span> <span class="nv">key-type</span><span class="p">]</span>
  <span class="s">&quot;Takes a Base64-encoded string of key data and formats it</span>
<span class="s">   for file-output following openssl&#39;s convention of wrapping lines</span>
<span class="s">   at 64 characters and appending the appropriate header and footer for</span>
<span class="s">   the specified key type&quot;</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">chunked</span> <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">encoded</span>
                     <span class="p">(</span><span class="nf">partition</span> <span class="mi">64</span> <span class="mi">64</span> <span class="p">[])</span>
                     <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">apply str </span><span class="nv">%</span><span class="p">)))</span>
        <span class="nv">formatted</span> <span class="p">(</span><span class="nb">join </span><span class="s">&quot;\n&quot;</span> <span class="nv">chunked</span><span class="p">)]</span>
    <span class="p">(</span><span class="nb">str </span><span class="s">&quot;-----BEGIN &quot;</span> <span class="nv">key-type</span> <span class="s">&quot;-----\n&quot;</span>
         <span class="nv">formatted</span>
         <span class="s">&quot;\n-----END &quot;</span> <span class="nv">key-type</span> <span class="s">&quot;-----\n&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">private-key-&gt;pem-string</span> <span class="p">[</span><span class="nv">key</span><span class="p">]</span>
  <span class="s">&quot;Convert RSA private keypair to a formatted PEM string for saving in</span>
<span class="s">   a .pem file. By default these private keys will encode themselves as PKCS#8</span>
<span class="s">   data (e.g. when calling (.getEncoded private-key)), so we have to convert it</span>
<span class="s">   to ASN1, which PEM uses (this seems to also be referred to as PKCS#1).</span>
<span class="s">   More info here http://stackoverflow.com/questions/7611383/generating-rsa-keys-in-pkcs1-format-in-java&quot;</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">.getEncoded</span> <span class="nv">key</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">org.bouncycastle.asn1.pkcs.PrivateKeyInfo/getInstance</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.parsePrivateKey</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.toASN1Primitive</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.getEncoded</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">encode64</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">format-pem-string</span> <span class="s">&quot;RSA PRIVATE KEY&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">public-key-&gt;pem-string</span> <span class="p">[</span><span class="nv">key</span><span class="p">]</span>
  <span class="s">&quot;Generate PEM-formatted string for a public key. This is simply a base64</span>
<span class="s">   encoding of the key wrapped with the appropriate header and footer.&quot;</span>
  <span class="p">(</span><span class="nf">format-pem-string</span> <span class="p">(</span><span class="nf">encode64</span> <span class="p">(</span><span class="nf">.getEncoded</span> <span class="nv">key</span><span class="p">))</span>
                     <span class="s">&quot;PUBLIC KEY&quot;</span><span class="p">))</span>
</pre></div>
<p>One last note about PEM formatting and keys &#8211; in some instances a PEM key is simply the same Base64-encoded DER representation of the key wrapped with the &#8220;BEGIN KEY&#8221; / &#8220;END KEY&#8221; header and footer. However the PEM format can be used slightly differently by a variety of key types, and because of this it sometimes needs to include additional metadata about what key format is being encoded.</p>
<h2>Further Reading</h2>
<p>The ins and outs of serializing cryptographic keys can get pretty complex, and there are unfortunately a lot of ways to do things using very similar encoding formats. I&#8217;ve managed to cobble together enough for the use-cases I needed here, but if you&#8217;d like to understand more, <a href="https://tls.mbed.org/kb/cryptography/asn1-key-structures-in-der-and-pem">here is a good article</a> that goes into more depth.</p>

</article>

      </main>

    </div>

  </body>
</html>
