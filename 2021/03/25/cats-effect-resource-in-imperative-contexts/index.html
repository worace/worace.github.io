<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="last-modified" content="2021-11-17T16:33:13-08:00" />

  <title>
    
      Using Cats Effect Resource in Non-Functional Contexts
    
  </title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300;400&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet"> 

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/TroutIcon48x48.png">
  <link rel="alternate" type="application/atom+xml" title="Horace Williams" href="/atom.xml">

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117025935-1"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-117025935-1');
  </script>
  
</head>


  <body>

    <div class="container content">
      
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Horace Williams</a>
        </h3>
        <ul class="nav-links">
          <li><a href="/about">about</a></li>
          <li><a target="_blank" class="nav-twitter" href="https://twitter.com/worace"><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48"><path d="M 32 6 C 26.568583 6 22.160643 10.388731 22.042969 15.792969 C 17.240727 15.216998 14.113589 13.421507 12.195312 11.652344 C 10.067982 9.6903754 9.3945312 7.9472656 9.3945312 7.9472656 A 1.50015 1.50015 0 0 0 6.8007812 7.5996094 C 6.8007812 7.5996094 5 10 5 13.5 C 5 15.500985 5.6317952 16.981554 6.3847656 18.236328 C 6.3570276 18.223338 6.1699219 18.158203 6.1699219 18.158203 A 1.50015 1.50015 0 0 0 4.0058594 19.636719 C 4.0058594 19.636719 4.5832039 23.856843 8.5507812 26.941406 L 8.1367188 27.044922 A 1.50015 1.50015 0 0 0 7.1972656 29.244141 C 7.1972656 29.244141 7.8700527 30.382221 9.2792969 31.580078 C 10.11485 32.290298 11.34227 33.023169 12.789062 33.701172 C 11.012271 34.35044 8.362818 35 4.5 35 A 1.50015 1.50015 0 0 0 3.3710938 37.488281 C 3.3710938 37.488281 4.5173251 38.751002 6.7832031 39.849609 C 9.0490812 40.948217 12.539474 42 17.5 42 C 26.219697 42 32.484656 37.817151 36.394531 32.515625 C 40.304407 27.214099 42 20.861111 42 16 C 42 15.691547 41.980739 15.387437 41.953125 15.085938 C 44.064371 13.051602 44.856626 11.522235 44.894531 11.447266 C 45.084531 11.066266 45.01375 10.608688 44.71875 10.304688 C 44.42475 9.9996875 43.969031 9.9137969 43.582031 10.091797 L 43.419922 10.166016 C 43.280922 10.230016 43.141953 10.294422 43.001953 10.357422 C 43.408953 9.7084219 43.730125 9.014875 43.953125 8.296875 C 44.077125 7.900875 43.943234 7.4669375 43.615234 7.2109375 C 43.287234 6.9549375 42.835469 6.9275312 42.480469 7.1445312 C 41.258221 7.8873594 40.086652 8.40739 38.867188 8.7558594 C 37.072578 7.0534724 34.656873 6 32 6 z M 32 9 C 35.883178 9 39 12.116822 39 16 C 39 20.138889 37.445593 26.035901 33.980469 30.734375 C 30.515344 35.432849 25.280303 39 17.5 39 C 13.7348 39 11.230189 38.318942 9.3535156 37.582031 C 11.319341 37.276755 13.011947 36.869367 14.228516 36.398438 C 16.338182 35.581792 17.476563 34.638672 17.476562 34.638672 A 1.50015 1.50015 0 0 0 16.863281 32.044922 C 14.140556 31.364241 12.394328 30.263307 11.298828 29.345703 L 12.863281 28.955078 A 1.50015 1.50015 0 0 0 13.039062 26.099609 C 9.7939415 24.851486 8.4312292 23.086373 7.734375 21.607422 C 8.5823538 21.782967 9.3718961 22 10.5 22 A 1.50015 1.50015 0 0 0 11.169922 19.158203 C 11.169922 19.158203 8 17.7 8 13.5 C 8 12.745947 8.2088435 12.268355 8.3613281 11.697266 C 8.884507 12.400354 9.3156815 13.07859 10.160156 13.857422 C 12.734824 16.231954 16.990366 18.653154 23.419922 18.998047 A 1.50015 1.50015 0 0 0 25 17.5 L 25 16 C 25 12.116822 28.116822 9 32 9 z"/></svg>
</a></li>
        </ul>
      </header>
      

      <main>
        <article class="post">
  <h1 class="post-title">Using Cats Effect Resource in Non-Functional Contexts</h1>
  <h2 class="post-subtitle"><em></em></h2>
  <time datetime="2021-03-25T00:00:00-07:00" class="post-date">25 Mar 2021</time>
  <h3 id="summary--tldr">Summary / TL;DR</h3>

<p>Use <a href="https://typelevel.org/cats-effect/api/cats/effect/Resource.html#allocated[G[x]%3E:F[x],B%3E:A](implicitF:cats.effect.BracketThrow[G]):G[(B,G[Unit])]">Resource.allocated</a> to integrate <code class="highlighter-rouge">cats.effect.Resource</code> into non-FP contexts such as a test framework setup/teardown methods or traditional callback-driven APIs. But be cautious in doing so, as it’s now your responsibility to make sure the provided finalizer gets called at the appropriate time.</p>

<h3 id="background">Background</h3>

<p><a href="https://typelevel.org/cats-effect/datatypes/resource.html">Cats Effect Resource</a> is an excellent tool for managing resource lifecycles in Scala. It provides something similar to Python’s <a href="https://docs.python.org/3/reference/compound_stmts.html#the-with-statement">‘with’ helper</a> or Java’s <a href="https://www.baeldung.com/java-try-with-resources">Try With Resources</a> but in a functional API that plays nice with <code class="highlighter-rouge">cats.effect.IO</code> or other pure effect types in Scala.</p>

<p>There are several ways to define a <code class="highlighter-rouge">Resource</code> but my preference is using <code class="highlighter-rouge">Resource.make</code>, which follows a familiar “acquire” / “release” pattern:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">java.io.FileWriter</span>

<span class="c1">// Resource's signature is Resource[+F[_], +A], containing 2 type parameters:
// an effect F (e.g. cats.effect.IO)
// and the resource type A
</span><span class="k">val</span> <span class="n">myFile</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">FileWriter</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Resource</span><span class="o">.</span><span class="n">make</span> <span class="o">{</span>
  <span class="c1">// acquire the resource by providing an IO[A] which generates it
</span>  <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="s">"pizza.txt"</span><span class="o">))</span>
<span class="o">}</span> <span class="o">{</span> <span class="n">file</span><span class="k">:</span> <span class="kt">FileWriter</span> <span class="o">=&gt;</span>
  <span class="c1">// release the resource by providing an IO[Unit] which closes it
</span>  <span class="c1">// Note that this block receives the resource as a parameter
</span>  <span class="nc">IO</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="o">())</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This “double block” syntax can be unfamiliar at first, but it’s simply exploiting Scala’s <a href="https://docs.scala-lang.org/tour/multiple-parameter-lists.html">multiple parameter lists</a> to accept the acquire and release args in sequence without wrapping parentheses.</p>

<p>Once you’ve constructed a resource (or rather, defined the logic for constructing it, as the actual construction is deferred), you can access it via the <code class="highlighter-rouge">use</code> method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">myFile</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">FileWriter</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">val</span> <span class="n">result</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">myFile</span><span class="o">.</span><span class="n">use</span> <span class="o">{</span> <span class="n">file</span> <span class="k">=&gt;</span>
  <span class="nc">IO</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="s">"pepperoni"</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="integrating-resource-into-an-app">Integrating Resource into an App</h2>

<p>Note that the block provided to <code class="highlighter-rouge">use</code> also expects an <code class="highlighter-rouge">IO</code> (its signature is <code class="highlighter-rouge">(f: (A) =&gt; G[B])</code>) and yields an <code class="highlighter-rouge">IO[B]</code>. <code class="highlighter-rouge">Resource</code>’s machinery folds the effectful acquire/release operations into the rest of your program so the whole thing distills into a single <code class="highlighter-rouge">IO[Blah]</code>.</p>

<p>This works especially smoothly in contexts where you can put the resource-management on the “outside” of your program, such as in <a href="https://typelevel.org/cats-effect/datatypes/ioapp.html">IOApp</a>. It’s very common to see <code class="highlighter-rouge">IOApp</code> used along this pattern:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>

<span class="k">object</span> <span class="nc">Main</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">context</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">MyApp</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="n">use</span> <span class="o">{</span> <span class="n">app</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">app</span><span class="o">.</span><span class="n">doStuff</span>
      <span class="n">res</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="resource-in-less-friendly-contexts">Resource in less friendly contexts</h3>

<p>However, sometimes we don’t have total control over the layering of a program, and instead have to fit a functional core, which may be heavily IO-based, into an imperative shell, which is not. This comes up commonly in scenarious such as:</p>

<ul>
  <li>Test frameworks, which often use an imperative, stateful API for defining fixtures via a <code class="highlighter-rouge">setup</code> / <code class="highlighter-rouge">teardown</code> protocol.</li>
  <li>Traditional hook-driven APIs, such as web frameworks that provide their own lifecycle methods. For example, I ran into this recently trying to integrate <code class="highlighter-rouge">cats.effect.Resource</code> into the <a href="https://www.playframework.com/documentation/2.8.x/api/scala/play/api/inject/ApplicationLifecycle.html#addStopHook(hook:()=%3Escala.concurrent.Future[_]):Unit">ApplicationLifecycle</a> of a Play application.</li>
</ul>

<p>Luckily, Resource does provide an escape hatch for these situations: <a href="https://typelevel.org/cats-effect/api/cats/effect/Resource.html#allocated[G[x]%3E:F[x],B%3E:A](implicitF:cats.effect.BracketThrow[G]):G[(B,G[Unit])]">Resource.allocated</a>.</p>

<p><code class="highlighter-rouge">Resource.allocated</code> basically provides an unsafe method for “unnesting” the typical resource management flow. Instead of <code class="highlighter-rouge">use</code>-ing your resource by providing an inner IO, you retrieve the value of it immediately, along with a callback which you are responsible for invoking to trigger the necessary release steps:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">appResource</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">MyApp</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="c1">// this IO[Unit] is your deferred finalizer
</span><span class="k">val</span> <span class="n">appLauncher</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[(</span><span class="kt">MyApp</span>, <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])]</span> <span class="k">=</span> <span class="n">appResource</span><span class="o">.</span><span class="n">allocated</span>
<span class="k">val</span> <span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">shutdownHook</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">MyApp</span><span class="o">,</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span> <span class="k">=</span> <span class="n">impLauncher</span><span class="o">.</span><span class="n">unsafeRunSync</span><span class="o">()</span>

<span class="c1">// Patch the provided finalizer into the application's shutdown lifecycle
</span><span class="n">myLifeCycle</span><span class="o">.</span><span class="n">addStopHook</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">shutdownHook</span><span class="o">.</span><span class="n">unsafeToFuture</span><span class="o">())</span>
</code></pre></div></div>

<p>This is certainly not the ideal way to use <code class="highlighter-rouge">cats.effect.Resource</code>, but it’s a useful escape hatch to have when needed. As always, heed the warnings from the docs:</p>

<blockquote>
  <p>For this reason, this is an advanced and potentially unsafe api which can cause a resource leak if not used correctly, please prefer <code class="highlighter-rouge">use</code> as the standard way of running a Resource program.</p>
</blockquote>

<p>So if you do resort to manual use of <code class="highlighter-rouge">.allocated</code>, just make sure you’re careful about cleaning up your resources at the appropriate time.</p>

</article>

      </main>

    </div>

  </body>
</html>
