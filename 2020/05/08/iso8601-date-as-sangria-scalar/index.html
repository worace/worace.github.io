<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="last-modified" content="2021-04-13T09:43:49-07:00" />

  <title>
    
      Sangria Scalar for ISO 8601 Dates
    
  </title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300;400&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet"> 

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/TroutIcon48x48.png">
  <link rel="alternate" type="application/atom+xml" title="Horace Williams" href="/atom.xml">

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117025935-1"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-117025935-1');
  </script>
  
</head>


  <body>

    <div class="container content">
      
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Horace Williams</a>
        </h3>
        <ul class="nav-links">
          <li><a href="/about">about</a></li>
        </ul>
      </header>
      

      <main>
        <article class="post">
  <h1 class="post-title">Sangria Scalar for ISO 8601 Dates</h1>
  <h2 class="post-subtitle"><em></em></h2>
  <time datetime="2020-05-08T00:00:00-07:00" class="post-date">08 May 2020</time>
  <p>Today I had to figure out how to encode a <code>java.util.Date</code> as a GraphQL Scalar using <a href="https://sangria-graphql.org/">Sangria</a>. <a href="https://graphql.org/learn/schema/#scalar-types">Scalars</a> in GraphQL are basically fancy strings that let you encode custom data types. This one reads and writes a <code>java.util.Date</code> as an <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a>-formatted string, which looks like &#8220;2020-05-09T03:20:28Z.&#8221; If your dates are not in UTC you may have a bad time, so don&#8217;t do that.</p>
<p>Here it is!</p>
<div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.util.Try</span>
<span class="k">import</span> <span class="nn">java.time.format.DateTimeFormatter</span>
<span class="k">import</span> <span class="nn">java.time.Instant</span>
<span class="k">import</span> <span class="nn">java.util.</span><span class="o">{</span><span class="nc">Date</span><span class="o">,</span> <span class="nc">TimeZone</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">sangria.validation.ValueCoercionViolation</span>
<span class="k">import</span> <span class="nn">sangria.schema._</span>
<span class="k">import</span> <span class="nn">sangria.ast._</span>

<span class="c1">// Helper object for doing the decoding. I put this in a utils package</span>
<span class="k">object</span> <span class="nc">ISO8601</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">tz</span> <span class="k">=</span> <span class="nc">TimeZone</span><span class="o">.</span><span class="n">getTimeZone</span><span class="o">(</span><span class="s">&quot;UTC&quot;</span><span class="o">).</span><span class="n">toZoneId</span>
  <span class="k">val</span> <span class="n">formatter</span> <span class="k">=</span> <span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="nc">ISO_INSTANT</span><span class="o">.</span><span class="n">withZone</span><span class="o">(</span><span class="n">tz</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Date</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Try</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">temporalAccessor</span>  <span class="k">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">instant</span> <span class="k">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="n">temporalAccessor</span><span class="o">)</span>
    <span class="nc">Date</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="n">instant</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">encode</span><span class="o">(</span><span class="n">date</span><span class="k">:</span> <span class="kt">Date</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">localDateTime</span> <span class="k">=</span> <span class="n">date</span><span class="o">.</span><span class="n">toInstant</span><span class="o">.</span><span class="n">atZone</span><span class="o">(</span><span class="n">tz</span><span class="o">).</span><span class="n">toLocalDateTime</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">localDateTime</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Scalars</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">def</span> <span class="n">parseDate</span><span class="o">(</span><span class="n">dt</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">ValueCoercionViolation</span>, <span class="kt">Date</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">ISO8601</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">dt</span><span class="o">).</span><span class="n">toOption</span><span class="o">.</span><span class="n">toRight</span><span class="o">(</span><span class="nc">InvalidDateTimeViolation</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">InvalidDateTimeViolation</span>
    <span class="k">extends</span> <span class="nc">ValueCoercionViolation</span><span class="o">(</span><span class="s">&quot;Input is not valid Date.&quot;</span><span class="o">)</span>
  <span class="c1">// The actual Scalar definition. Import this implicit when defining your schema</span>
  <span class="c1">// to be enable Sangria to infer schemas for case classes that have Date memebers</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nc">DateType</span> <span class="k">=</span> <span class="nc">ScalarType</span><span class="o">[</span><span class="kt">Date</span><span class="o">](</span>
    <span class="s">&quot;Date&quot;</span><span class="o">,</span>
    <span class="n">coerceOutput</span> <span class="k">=</span> <span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">ISO8601</span><span class="o">.</span><span class="n">encode</span><span class="o">(</span><span class="n">date</span><span class="o">),</span>
    <span class="n">coerceInput</span> <span class="k">=</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">StringValue</span><span class="o">(</span><span class="n">dt</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span> <span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">parseDate</span><span class="o">(</span><span class="n">dt</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="nc">InvalidDateTimeViolation</span><span class="o">)</span>
    <span class="o">},</span>
    <span class="n">coerceUserInput</span> <span class="k">=</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="n">parseDate</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="nc">InvalidDateTimeViolation</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div>

</article>

      </main>

    </div>

  </body>
</html>
