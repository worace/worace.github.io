<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="last-modified" content="2021-04-13T12:41:16-07:00" />

  <title>
    
      Identify Non-HTTPS Transitive Leiningen Dependencies
    
  </title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300;400&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet"> 

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/TroutIcon48x48.png">
  <link rel="alternate" type="application/atom+xml" title="Horace Williams" href="/atom.xml">

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117025935-1"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-117025935-1');
  </script>
  
</head>


  <body>

    <div class="container content">
      
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Horace Williams</a>
        </h3>
        <ul class="nav-links">
          <li><a href="/about">about</a></li>
          <li><a target="_blank" class="nav-twitter" href="https://twitter.com/worace"><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48"><path d="M 32 6 C 26.568583 6 22.160643 10.388731 22.042969 15.792969 C 17.240727 15.216998 14.113589 13.421507 12.195312 11.652344 C 10.067982 9.6903754 9.3945312 7.9472656 9.3945312 7.9472656 A 1.50015 1.50015 0 0 0 6.8007812 7.5996094 C 6.8007812 7.5996094 5 10 5 13.5 C 5 15.500985 5.6317952 16.981554 6.3847656 18.236328 C 6.3570276 18.223338 6.1699219 18.158203 6.1699219 18.158203 A 1.50015 1.50015 0 0 0 4.0058594 19.636719 C 4.0058594 19.636719 4.5832039 23.856843 8.5507812 26.941406 L 8.1367188 27.044922 A 1.50015 1.50015 0 0 0 7.1972656 29.244141 C 7.1972656 29.244141 7.8700527 30.382221 9.2792969 31.580078 C 10.11485 32.290298 11.34227 33.023169 12.789062 33.701172 C 11.012271 34.35044 8.362818 35 4.5 35 A 1.50015 1.50015 0 0 0 3.3710938 37.488281 C 3.3710938 37.488281 4.5173251 38.751002 6.7832031 39.849609 C 9.0490812 40.948217 12.539474 42 17.5 42 C 26.219697 42 32.484656 37.817151 36.394531 32.515625 C 40.304407 27.214099 42 20.861111 42 16 C 42 15.691547 41.980739 15.387437 41.953125 15.085938 C 44.064371 13.051602 44.856626 11.522235 44.894531 11.447266 C 45.084531 11.066266 45.01375 10.608688 44.71875 10.304688 C 44.42475 9.9996875 43.969031 9.9137969 43.582031 10.091797 L 43.419922 10.166016 C 43.280922 10.230016 43.141953 10.294422 43.001953 10.357422 C 43.408953 9.7084219 43.730125 9.014875 43.953125 8.296875 C 44.077125 7.900875 43.943234 7.4669375 43.615234 7.2109375 C 43.287234 6.9549375 42.835469 6.9275312 42.480469 7.1445312 C 41.258221 7.8873594 40.086652 8.40739 38.867188 8.7558594 C 37.072578 7.0534724 34.656873 6 32 6 z M 32 9 C 35.883178 9 39 12.116822 39 16 C 39 20.138889 37.445593 26.035901 33.980469 30.734375 C 30.515344 35.432849 25.280303 39 17.5 39 C 13.7348 39 11.230189 38.318942 9.3535156 37.582031 C 11.319341 37.276755 13.011947 36.869367 14.228516 36.398438 C 16.338182 35.581792 17.476563 34.638672 17.476562 34.638672 A 1.50015 1.50015 0 0 0 16.863281 32.044922 C 14.140556 31.364241 12.394328 30.263307 11.298828 29.345703 L 12.863281 28.955078 A 1.50015 1.50015 0 0 0 13.039062 26.099609 C 9.7939415 24.851486 8.4312292 23.086373 7.734375 21.607422 C 8.5823538 21.782967 9.3718961 22 10.5 22 A 1.50015 1.50015 0 0 0 11.169922 19.158203 C 11.169922 19.158203 8 17.7 8 13.5 C 8 12.745947 8.2088435 12.268355 8.3613281 11.697266 C 8.884507 12.400354 9.3156815 13.07859 10.160156 13.857422 C 12.734824 16.231954 16.990366 18.653154 23.419922 18.998047 A 1.50015 1.50015 0 0 0 25 17.5 L 25 16 C 25 12.116822 28.116822 9 32 9 z"/></svg>
</a></li>
        </ul>
      </header>
      

      <main>
        <article class="post">
  <h1 class="post-title">Identify Non-HTTPS Transitive Leiningen Dependencies</h1>
  <h2 class="post-subtitle"><em></em></h2>
  <time datetime="2018-05-29T00:00:00-07:00" class="post-date">29 May 2018</time>
  <p>If you&#8217;ve been using Leiningen any time over the last several months you have likely run into the dreaded error: <code>Tried to use insecure HTTP repository without TLS</code>.</p>
<p>This is due to a change in <a href="https://github.com/technomancy/leiningen/blob/master/NEWS.md#280-rc1--2017-09-18">Leiningen 2.8</a> which blocks non-TLS remote maven repositories. The change itself is well-intentioned and reasonable: relying on non-HTTPS dependencies is, overall, a bad idea. However dealing with it has caused lots of headaches for people who have a non-HTTPS dependency buried somewhere in their tree but don&#8217;t know which one it is or where it&#8217;s coming from.</p>
<p>The Leiningen FAQ contains a note directing you to either track down the offending dependency and exclude it, or include a scary code snippet in your <code>project.clj</code> file:</p>
<p>Others I know have even resorted to just downgrading back to Leiningen 2.7.1 to avoid dealing with this issue (j.k. this was definitely me for a while).</p>
<h3>Find problematic dependencies</h3>
<p>Unfortunately Leiningen and the dependency-management tools it uses under the hood (e.g. <a href="https://wiki.eclipse.org/Aether/What_Is_Aether">Aether</a>) don&#8217;t currently have an out-of-the-box solution for pointing out which of your transitive deps are being pulled in from non-TLS sources.</p>
<p>However it is possible to cobble together something using existing tools:</p>
<h4>1. Add the &#8220;Never do this&#8221; snippet to your <code>project.clj</code>:</h4>
<div class="highlight"><pre><span></span><span class="c1">;; never do this</span>
<span class="p">(</span><span class="nf">require</span> <span class="ss">&#39;cemerick.pomegranate.aether</span><span class="p">)</span>
<span class="p">(</span><span class="nf">cemerick.pomegranate.aether/register-wagon-factory!</span>
 <span class="s">&quot;http&quot;</span> <span class="o">#</span><span class="p">(</span><span class="nf">org.apache.maven.wagon.providers.http.HttpWagon.</span><span class="p">))</span>
</pre></div>
<p>Just temporarily, we&#8217;ll take it out once we&#8217;re done.</p>
<h4>2. Generate a <code>pom.xml</code> file for your project:</h4>
<div class="highlight"><pre><span></span>lein pom
</pre></div>
<p>Because we added the TLS authorization snippet, leiningen should be able to download whatever it needs to succeed in this step.</p>
<p>This will let us use maven dependency management plugins since they can read the generated pom.xml file.</p>
<h4>3. Clear your maven cache</h4>
<div class="highlight"><pre><span></span>rm -rf ~/.m2/repository
</pre></div>
<p>This will force maven to re-download dependencies in the next step.</p>
<p>In theory there are other maven tools like the <a href="https://maven.apache.org/plugins/maven-dependency-plugin/purge-local-repository-mojo.html">purge-local-repository</a> plugin which would let us do this without destroying the whole cache, but I found they missed some insecure dependencies in my project. YMMV.</p>
<p>If you&#8217;re concerned about losing stuff in your cache you can always save it somewhere and move it back when you&#8217;re done: <code>mv ~/.m2/repository ~/.m2/repository_BAK</code>.</p>
<h4>4. Use maven to download your deps</h4>
<div class="highlight"><pre><span></span>mvn dependency:tree &gt; tree.txt
</pre></div>
<p>The trick here is that maven is a little more verbose when downloading dependencies than leiningen, and it will show you the full URL which was used to retrieve each package.</p>
<h4>5. Search for any non-https entries</h4>
<div class="highlight"><pre><span></span>grep <span class="s2">&quot;http:&quot;</span> tree.txt
</pre></div>
<p>You should find some entries like:</p>
<p><code>Downloading: http://maven.my-company.com/nexus/content/groups/public/com/mycorp/mypackage/1.0.0/maven-metadata.xml</code></p>
<p>These will be the ones you want to exclude.</p>
<h3>Exclude the offending entries</h3>
<p>Remember that a maven artifact URL like <code>http://maven.my-company.com/nexus/content/groups/public/com/mycorp/mypackage/1.0.0/maven-metadata.xml</code> translates to <code>[com.mycorp/mypackage &quot;1.0.0&quot;]</code> in leiningen vector form.</p>
<p>Once you&#8217;ve identified the problematic deps, you can exclude them using the <a href="https://github.com/technomancy/leiningen/blob/master/sample.project.clj#L91-L92">:exclusions key</a> in your project.clj:</p>
<div class="highlight"><pre><span></span><span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">com.mycorp/mypackage</span><span class="p">]</span>
</pre></div>
<p>If they turn out to be things you actually need, you may have to go find a compatible version from an HTTPS source to replace them with.</p>
<h3>Clean Up</h3>
<p>Finally, to clean up all the debugging you had to do to get here:</p>
<ul>
  <li>Remove the <code>Never do this</code> HTTP authorization snippet from your <code>project.clj</code></li>
  <li>Clear your maven cache again to wipe out any non-https dependencies you downloaded in the process</li>
</ul>

</article>

      </main>

    </div>

  </body>
</html>
