<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="last-modified" content="2021-04-04T22:00:55-07:00" />

  <title>
    
      Identify Non-HTTPS Transitive Leiningen Dependencies
      
    
  </title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300;400&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet"> 

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/TroutIcon48x48.png">
  <link rel="alternate" type="application/atom+xml" title="Horace Williams" href="/atom.xml">

  
</head>


  <body>

    <div class="container content">
      
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Horace Williams</a>
        </h3>
        <ul class="nav-links">
          <li><a href="/about">about</a></li>
        </ul>
      </header>
      

      <main>
        <article class="post">
  <h1 class="post-title">Identify Non-HTTPS Transitive Leiningen Dependencies</h1>
  <h2 class="post-subtitle"><em></em></h2>
  <time datetime="2018-05-29T00:00:00-07:00" class="post-date">29 May 2018</time>
  <p>If you&#8217;ve been using Leiningen any time over the last several months you have likely run into the dreaded error: <code>Tried to use insecure HTTP repository without TLS</code>.</p>
<p>This is due to a change in <a href="https://github.com/technomancy/leiningen/blob/master/NEWS.md#280-rc1--2017-09-18">Leiningen 2.8</a> which blocks non-TLS remote maven repositories. The change itself is well-intentioned and reasonable: relying on non-HTTPS dependencies is, overall, a bad idea. However dealing with it has caused lots of headaches for people who have a non-HTTPS dependency buried somewhere in their tree but don&#8217;t know which one it is or where it&#8217;s coming from.</p>
<p>The Leiningen FAQ contains a note directing you to either track down the offending dependency and exclude it, or include a scary code snippet in your <code>project.clj</code> file:</p>
<p>Others I know have even resorted to just downgrading back to Leiningen 2.7.1 to avoid dealing with this issue (j.k. this was definitely me for a while).</p>
<h3>Find problematic dependencies</h3>
<p>Unfortunately Leiningen and the dependency-management tools it uses under the hood (e.g. <a href="https://wiki.eclipse.org/Aether/What_Is_Aether">Aether</a>) don&#8217;t currently have an out-of-the-box solution for pointing out which of your transitive deps are being pulled in from non-TLS sources.</p>
<p>However it is possible to cobble together something using existing tools:</p>
<h4>1. Add the &#8220;Never do this&#8221; snippet to your <code>project.clj</code>:</h4>
<div class="highlight"><pre><span></span><span class="c1">;; never do this</span>
<span class="p">(</span><span class="nf">require</span> <span class="ss">&#39;cemerick.pomegranate.aether</span><span class="p">)</span>
<span class="p">(</span><span class="nf">cemerick.pomegranate.aether/register-wagon-factory!</span>
 <span class="s">&quot;http&quot;</span> <span class="o">#</span><span class="p">(</span><span class="nf">org.apache.maven.wagon.providers.http.HttpWagon.</span><span class="p">))</span>
</pre></div>
<p>Just temporarily, we&#8217;ll take it out once we&#8217;re done.</p>
<h4>2. Generate a <code>pom.xml</code> file for your project:</h4>
<div class="highlight"><pre><span></span>lein pom
</pre></div>
<p>Because we added the TLS authorization snippet, leiningen should be able to download whatever it needs to succeed in this step.</p>
<p>This will let us use maven dependency management plugins since they can read the generated pom.xml file.</p>
<h4>3. Clear your maven cache</h4>
<div class="highlight"><pre><span></span>rm -rf ~/.m2/repository
</pre></div>
<p>This will force maven to re-download dependencies in the next step.</p>
<p>In theory there are other maven tools like the <a href="https://maven.apache.org/plugins/maven-dependency-plugin/purge-local-repository-mojo.html">purge-local-repository</a> plugin which would let us do this without destroying the whole cache, but I found they missed some insecure dependencies in my project. YMMV.</p>
<p>If you&#8217;re concerned about losing stuff in your cache you can always save it somewhere and move it back when you&#8217;re done: <code>mv ~/.m2/repository ~/.m2/repository_BAK</code>.</p>
<h4>4. Use maven to download your deps</h4>
<div class="highlight"><pre><span></span>mvn dependency:tree &gt; tree.txt
</pre></div>
<p>The trick here is that maven is a little more verbose when downloading dependencies than leiningen, and it will show you the full URL which was used to retrieve each package.</p>
<h4>5. Search for any non-https entries</h4>
<div class="highlight"><pre><span></span>grep <span class="s2">&quot;http:&quot;</span> tree.txt
</pre></div>
<p>You should find some entries like:</p>
<p><code>Downloading: http://maven.my-company.com/nexus/content/groups/public/com/mycorp/mypackage/1.0.0/maven-metadata.xml</code></p>
<p>These will be the ones you want to exclude.</p>
<h3>Exclude the offending entries</h3>
<p>Remember that a maven artifact URL like <code>http://maven.my-company.com/nexus/content/groups/public/com/mycorp/mypackage/1.0.0/maven-metadata.xml</code> translates to <code>[com.mycorp/mypackage &quot;1.0.0&quot;]</code> in leiningen vector form.</p>
<p>Once you&#8217;ve identified the problematic deps, you can exclude them using the <a href="https://github.com/technomancy/leiningen/blob/master/sample.project.clj#L91-L92">:exclusions key</a> in your project.clj:</p>
<div class="highlight"><pre><span></span><span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">com.mycorp/mypackage</span><span class="p">]</span>
</pre></div>
<p>If they turn out to be things you actually need, you may have to go find a compatible version from an HTTPS source to replace them with.</p>
<h3>Clean Up</h3>
<p>Finally, to clean up all the debugging you had to do to get here:</p>
<ul>
  <li>Remove the <code>Never do this</code> HTTP authorization snippet from your <code>project.clj</code></li>
  <li>Clear your maven cache again to wipe out any non-https dependencies you downloaded in the process</li>
</ul>

</article>

      </main>

    </div>

  </body>
</html>
